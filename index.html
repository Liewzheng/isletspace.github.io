<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://code.islet.space/font//css?family=/CascadiaCode/CascadiaCode:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"islet.space","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/db.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>
<meta name="description" content="笔记分享的旮旯孤岛而已">
<meta property="og:type" content="website">
<meta property="og:title" content="Coder的孤岛">
<meta property="og:url" content="http://islet.space/index.html">
<meta property="og:site_name" content="Coder的孤岛">
<meta property="og:description" content="笔记分享的旮旯孤岛而已">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Liewzheng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://islet.space/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Coder的孤岛</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Coder的孤岛</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">islet of the coder</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-文章"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>文章</a></li>
        <li class="menu-item menu-item-目录"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>目录</a></li>
        <li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-简历"><a href="/resume/" rel="section"><i class="fa fa-address-card fa-fw"></i>简历</a></li>
        <li class="menu-item menu-item-友链"><a href="/friends/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Liewzheng</p>
  <div class="site-description" itemprop="description">笔记分享的旮旯孤岛而已</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">112</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">210</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:liewzheng@foxmail.com" title="E-Mail → mailto:liewzheng@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/04/19/Communication/2022-01-18-HALF-DUPLEX-SPI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/19/Communication/2022-01-18-HALF-DUPLEX-SPI/" class="post-title-link" itemprop="url">HALF DUPLEX SPI</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-19 13:40:00" itemprop="dateCreated datePublished" datetime="2022-04-19T13:40:00+08:00">2022-04-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-04-20 20:05:04" itemprop="dateModified" datetime="2022-04-20T20:05:04+08:00">2022-04-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Communication/" itemprop="url" rel="index"><span itemprop="name">Communication</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="spi简介">SPI简介</h1>
<p>SPI 的物理线支持 <strong>三种类型</strong>：</p>
<ul>
<li><strong>片选线</strong>（NCS / CS / SS），某些数据手册会将 <strong>片选引脚</strong> 称为 <code>NSS</code> /<code>NCS</code> / <code>SEL</code> (<strong><em>Sel</em></strong>ect) / <code>CS</code> (<strong><em>C</em></strong>hip <strong><em>S</em></strong>elect) / <code>STE</code> (<strong><em>S</em></strong>laver <strong><em>T</em></strong>ransmit <strong><em>E</em></strong>nable)。</li>
<li><strong>时钟线</strong>（CLK / SCK）</li>
<li><strong>数据线</strong>（DA 或 MOSI 和 MISO ）（此处的 DA 特指单根支持半双工的数据线）。</li>
</ul>
<p><mark>需要注意的是，SPI的通信线有太多的名称，需要自行对照芯片手册进行查询，避免混淆。</mark></p>
<p>SPI 通过对硬件资源的使用修改（禁用片选、禁 / 复用数据线）可以达到 <strong>全双工</strong> 或 <strong>半双工</strong> 通信的目的。标准SPI为 四线SPI （CS / CLK / MOSI / MISO）；最低支持2根数据引脚（仅保留 CLK / DA，其中DA为分时复用数据线 ）来达到半双工通信的目的，可以增加一 / 多根 CS 来达到拓展SPI从设备片选的目的；也可以利用四根独立的半双工数据线，来达到 标准四线SPI 四倍通信能力 的 六线SPI（一般被称为 <code>Quad-IO SPI</code>）。</p>
<h2 id="spi分类">SPI分类</h2>
<p>SPI通信按GPIO 数量可以分类为 2~6线 SPI，包含单工、半双工、全双工三总。</p>
<table>
<thead>
<tr class="header">
<th>按GPIO数量分类</th>
<th>通信制式</th>
<th>通信线</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>两线SPI</td>
<td>单工/半双工</td>
<td>CLK / DA 或 CLK / MOSI 或 CLK / MISO</td>
</tr>
<tr class="even">
<td>三线SPI</td>
<td>单工/半双工/全双工</td>
<td>CS / CLK / DA 或 CLK / MOSI / MISO</td>
</tr>
<tr class="odd">
<td>四线SPI</td>
<td>全双工</td>
<td>CS / CLK / MOSI / MISO</td>
</tr>
<tr class="even">
<td>六线SPI</td>
<td>全双工</td>
<td>CS / CLK / DA1 / DA2 / DA3 / DA4</td>
</tr>
</tbody>
</table>
<blockquote>
<p>例如，据STM32L476RG芯片手册《<a target="_blank" rel="noopener" href="https://www.st.com/resource/en/reference_manual/rm0351-stm32l47xxx-stm32l48xxx-stm32l49xxx-and-stm32l4axxx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">RM0351</a>》第1450页所示，SPI外设可以被配置为以下三种模式，即 <strong>三线全双工</strong>，<strong>两线半双工</strong> 和 <strong>两线单工</strong>。</p>
<ul>
<li>Full-duplex synchronous transfers on three lines</li>
<li>Half-duplex synchronous transfer on two lines (with bidirectional data line)</li>
<li>Simplex synchronous transfers on two lines (with unidirectional data line)</li>
</ul>
</blockquote>
<h1 id="half-duplex-spi">HALF DUPLEX SPI</h1>
<p>半双工通信可以是 两线SPI 或 三线SPI，后面着重说明两者异同。</p>
<h2 id="pin-definition">PIN DEFINITION</h2>
<p><strong>NCS</strong>： SPI控制读写使能信号；<mark style="font-weight: 900;">使用时需要被拉低</mark>，否则SDIO会处在 HIGH-Z 态，而SCLK信号也会被无视。也可以被用于在通信错误发生时重置SPI 通信。两线SPI不需要这根线，但个别芯片可能需要这个引脚接地（不能悬空），具体看芯片手册。</p>
<p><strong>SDIO</strong>： SPI的数据读写端口；半双工读写。只有在“从被控设备读出数据”的情况下，<code>SDIO</code> 才会由被控制设备控制。</p>
<p><strong>SCLK</strong>： SPI接口时钟；<mark style="font-weight: 900;">总是由主控制器生成和控制。</mark></p>
<h2 id="transmission-protocol">TRANSMISSION PROTOCOL</h2>
<p>跟其他通信类似，SPI 的 SDIO 需要在 时钟低电平时 进行电平跳变。</p>
<p>半双工SPI读写操作都包含两个字（byte），第一个字包含1 bit的 <strong>数据方向（或称 控制位）</strong> 和 7 bit的 <strong>地址</strong>，第二个字包含 <strong>数据</strong>。</p>
<h3 id="关于数据方向控制位">关于数据方向/控制位</h3>
<p>通常定义是，当需要写入数据时，控制位写 <code>1</code> 。当需要读出数据时，控制位写 <code>0</code> 。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220118135819247.png" alt="image-20220118135819247" style="zoom: 50%;" /></p>
<p>但不一定所有支持半双工SPI的通信控制位都是在MSB，有可能是在 LSB 。</p>
<blockquote>
<p>如，下方右侧 SL8541E 的安卓平台主控，支持半双工SPI，但是其控制位就在地址字符的LSB上。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220419235450360.png" alt="image-20220419235450360" /><figcaption aria-hidden="true">image-20220419235450360</figcaption>
</figure>
</blockquote>
<h3 id="写操作">写操作</h3>
<p><mark style="font-weight:900;">主控制器在SCLK下降沿时改变 SDIO的电平，被控设备在SCLK上升沿时读取SDIO的电平。</mark></p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220118140526017.png" alt="image-20220118140526017" /><figcaption aria-hidden="true">image-20220118140526017</figcaption>
</figure>
<h3 id="读取操作">读取操作</h3>
<blockquote>
<p>SDIO会在SCLK下降沿时修改，主控制器需要在SCLK的上升沿时读取SDIO的电平信息。</p>
</blockquote>
<p><strong>注意</strong>：发送完地址字 之后需要延长半个周期的时钟低电平。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220118141033005.png" alt="image-20220118141033005" /><figcaption aria-hidden="true">image-20220118141033005</figcaption>
</figure>
<h1 id="debug-records">DEBUG RECORDS</h1>
<p>下面这个时序图错误的坑是真的大，调了好就才折腾明白，这不能是 <code>Hi-Z</code> 态。</p>
<h2 id="时序图错误">时序图错误</h2>
<p>内部调试时发现，SDIO在读取数据前后必须是 <strong>输出模式</strong>，最好 <strong>强制拉高</strong>，而不是 <code>Hi-Z</code> 态。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220419210753902.png" alt="image-20220419210753902" /><figcaption aria-hidden="true">image-20220419210753902</figcaption>
</figure>
<h2 id="读写单个字符">读写单个字符</h2>
<p>以下这两个函数中的 <code>for()</code> 使用了 MSB 发送数据，最好不要自作聪明将 <code>i</code> 的数据类型改为 <code>uint8_t</code> 或其他非负型数据，以下这种循环写法会让程序陷入死循环的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write_byte</span><span class="params">(<span class="keyword">uint8_t</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">7</span>; i&gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( (data &gt;&gt; i) &amp; <span class="number">0x01</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            write_high_level();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            write_low_level();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint8_t</span> <span class="title">read_byte</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> data = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">7</span>; i&gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        SCLK_SET_LOW;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line"></span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line"></span><br><span class="line">        data |= HAL_GPIO_ReadPin(SPI_DATA_GPIO_Port, SPI_DATA_Pin) &lt;&lt; i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="source-code">SOURCE CODE</h1>
<p>下方是适用于 STM32 平台的 <strong>GPIO-模拟</strong> <strong>半双工SPI</strong> 代码，利用 空指令进行延时控制，实现半双工（三线/两线）SPI 的通信。</p>
<p>需要适配以下几个功能：</p>
<ol type="1">
<li>控制精细度在 <span class="math inline">\([10^{-9}s:10^{-6}s]\)</span> 之间的 <strong>精准延时</strong>（如果做不到，通信速率就上不去 <code>1MHz</code> ）。</li>
<li>控制引脚电平的宏定义。</li>
<li><strong>设置数据接口输出</strong> 和 <strong>设置数据接口输入</strong> 的代码。</li>
<li><strong>拉高电平</strong> 和 <strong>拉低电平</strong> 的代码。</li>
<li>对照着 <strong>正确的时序图</strong> 撸一遍 <strong>读单字符</strong> 和 <strong>写单字符</strong> 的代码。</li>
<li>对照着 <strong>正确的时序图</strong> 撸一遍 <strong>写寄存器</strong> 和 <strong>读寄存器</strong> 的代码。</li>
</ol>
<p><strong>注意</strong>：都是按顺序来完成的，所有后面的功能都需要依托于前面的功能来实现。而且，需要用示波器（有条件）进行测量以校准通信速率，并使用正确的时序图进行编码（如果是错误的，浪费时间，尽快跟厂家确认）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * HEARDER FILES</span></span><br><span class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spi_access.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32l4xx_hal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;main.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * MACRO DEFINITIONS</span></span><br><span class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">// 通信引脚定义</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_DATA_Pin GPIO_PIN_5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_DATA_GPIO_Port GPIOC</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_CLK_Pin GPIO_PIN_6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_CLK_GPIO_Port GPIOC</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_CS_Pin GPIO_PIN_8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_CS_GPIO_Port GPIOC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义电平</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HIGH_LEVEL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIGH_LEVEL GPIO_PIN_SET</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LOW_LEVEL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOW_LEVEL GPIO_PIN_RESET</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义引脚电平控制</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDIO_SET_HIGH &#123;HAL_GPIO_WritePin(SPI_DATA_GPIO_Port,SPI_DATA_Pin,HIGH_LEVEL);&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDIO_SET_LOW  &#123;HAL_GPIO_WritePin(SPI_DATA_GPIO_Port,SPI_DATA_Pin,LOW_LEVEL);&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDIO_SET_IN   &#123;HAL_GPIO_ReadPin(SPI_DATA_GPIO_Port, SPI_DATA_Pin);&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCLK_SET_HIGH &#123;HAL_GPIO_WritePin(SPI_CLK_GPIO_Port, SPI_CLK_Pin, HIGH_LEVEL);&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCLK_SET_LOW  &#123;HAL_GPIO_WritePin(SPI_CLK_GPIO_Port, SPI_CLK_Pin, LOW_LEVEL);&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SNCS_SET_HIGH &#123;HAL_GPIO_WritePin(SPI_CS_GPIO_Port, SPI_CS_Pin, HIGH_LEVEL);&#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SNCS_SET_LOW  &#123;HAL_GPIO_WritePin(SPI_CS_GPIO_Port, SPI_CS_Pin, LOW_LEVEL);&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 电平延时</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEVEL_DELAY_SLICES 80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 寄存器（最大）尝试写入次数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_WRITE_TIMES 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * DATA TYPE DECLARATION</span></span><br><span class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">// spi句柄</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> handle;</span><br><span class="line">&#125; spi_dev;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * GLOBAL PARAMETERS</span></span><br><span class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> two_wired_spi;  <span class="comment">// 两线SPI使能开关</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * PRIVATE FUNCTIONS DEFINITION</span></span><br><span class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief delay for a slice of cpu</span></span><br><span class="line"><span class="comment"> * @param &#123;volatile uint32_t&#125; times</span></span><br><span class="line"><span class="comment"> * @return &#123;*&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delay_nop</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">uint32_t</span> times)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; times; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        __NOP();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief delay for 1us</span></span><br><span class="line"><span class="comment"> * @param &#123;volatile uint32_t&#125; times</span></span><br><span class="line"><span class="comment"> * @return &#123;*&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delay_us</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">uint32_t</span> times)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; times; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">        __NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();__NOP();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delay_ms</span><span class="params">(<span class="keyword">uint16_t</span> times)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">uint16_t</span> i = <span class="number">0</span>; i &lt; times; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        delay_us(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sdio_input_mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_InitStruct = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    GPIO_InitStruct.Pin = SPI_DATA_Pin;</span><br><span class="line">    GPIO_InitStruct.Mode = GPIO_MODE_INPUT;</span><br><span class="line">    HAL_GPIO_Init(SPI_DATA_GPIO_Port, &amp;GPIO_InitStruct);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sdio_output_mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_InitStruct = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    GPIO_InitStruct.Pin = SPI_DATA_Pin ;</span><br><span class="line">    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;</span><br><span class="line">    GPIO_InitStruct.Pull = GPIO_NOPULL;</span><br><span class="line">    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;</span><br><span class="line">    HAL_GPIO_Init(SPI_DATA_GPIO_Port, &amp;GPIO_InitStruct);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write_high_level</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SCLK_SET_LOW;</span><br><span class="line">    SDIO_SET_HIGH;</span><br><span class="line">    delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">    SCLK_SET_HIGH;</span><br><span class="line">    delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write_low_level</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SCLK_SET_LOW;</span><br><span class="line">    SDIO_SET_LOW;</span><br><span class="line">    delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">    SCLK_SET_HIGH;</span><br><span class="line">    delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write_byte</span><span class="params">(<span class="keyword">uint8_t</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">7</span>; i&gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( (data &gt;&gt; i) &amp; <span class="number">0x01</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            write_high_level();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            write_low_level();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint8_t</span> <span class="title">read_byte</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> data = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">7</span>; i&gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        SCLK_SET_LOW;</span><br><span class="line">        data |= HAL_GPIO_ReadPin(SPI_DATA_GPIO_Port, SPI_DATA_Pin) &lt;&lt; i;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line"></span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * PUBLIC FUNCTIONS DEFINITION</span></span><br><span class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">write_sensor_init</span><span class="params">(<span class="keyword">bool</span> switch_two_wired_spi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(switch_two_wired_spi) </span><br><span class="line">    &#123;</span><br><span class="line">        two_wired_spi = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        two_wired_spi = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spi_dev *instance = <span class="literal">NULL</span>;</span><br><span class="line">    instance = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(spi_dev));</span><br><span class="line">    <span class="built_in">memset</span>(instance, <span class="number">0</span>, <span class="keyword">sizeof</span>(spi_dev));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(two_wired_spi)</span><br><span class="line">    &#123;</span><br><span class="line">        SNCS_SET_LOW;</span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        delay_ms(<span class="number">5</span>);</span><br><span class="line">        SCLK_SET_LOW;</span><br><span class="line">        delay_ms(<span class="number">1</span>);</span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        delay_ms(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sdio_input_mode();</span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">        SCLK_SET_LOW;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    instance-&gt;handle = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_sensor_deinit</span><span class="params">(<span class="keyword">void</span>* handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (handle != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LOGE(<span class="string">&quot;ERROR: NULL spi handle.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_resynchronized</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (two_wired_spi)</span><br><span class="line">    &#123;</span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        SDIO_SET_HIGH;</span><br><span class="line">        delay_ms(<span class="number">2</span>);</span><br><span class="line">        SCLK_SET_LOW;</span><br><span class="line">        delay_us(<span class="number">1</span>);</span><br><span class="line">        SCLK_SET_HIGH;</span><br><span class="line">        delay_ms(<span class="number">2</span>);</span><br><span class="line">        SDIO_SET_IN;</span><br><span class="line">        delay_ms(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 暂时未完成</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_register</span><span class="params">(<span class="keyword">uint8_t</span> regAddr, <span class="keyword">uint8_t</span> regData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    regAddr |= <span class="number">0x80</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">uint8_t</span> write_times = <span class="number">0</span>; write_times &lt; MAX_WRITE_TIMES; write_times++)</span><br><span class="line">    &#123;</span><br><span class="line">        sdio_output_mode();  <span class="comment">// 设置SDIO为输出模式</span></span><br><span class="line">        SDIO_SET_HIGH;       <span class="comment">// 拉高SDIO电平</span></span><br><span class="line">        SCLK_SET_HIGH;       <span class="comment">// 拉高SCLK电平</span></span><br><span class="line">        delay_us(<span class="number">1</span>);         <span class="comment">// 2-wired spi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!two_wired_spi)</span><br><span class="line">        &#123;</span><br><span class="line">            SNCS_SET_LOW;    <span class="comment">// 拉低SNCS电平</span></span><br><span class="line">        &#125;</span><br><span class="line">        delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line"></span><br><span class="line">        write_byte(regAddr);</span><br><span class="line">        write_byte(regData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!two_wired_spi)</span><br><span class="line">        &#123;</span><br><span class="line">            SNCS_SET_HIGH;</span><br><span class="line">            sdio_input_mode();</span><br><span class="line">            delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            delay_us(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(read_register(regAddr) == regData) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOGE(<span class="string">&quot;ERROR: Write register failed.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint8_t</span> <span class="title">read_register</span><span class="params">(<span class="keyword">uint8_t</span> regAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> data = <span class="number">0</span>;</span><br><span class="line">    regAddr &amp;= <span class="number">0x7F</span>;     <span class="comment">// 设置为读取模式</span></span><br><span class="line"></span><br><span class="line">    sdio_output_mode();  <span class="comment">// 设置SDIO为输出模式</span></span><br><span class="line">    <span class="keyword">if</span>(two_wired_spi) delay_us(<span class="number">10</span>);</span><br><span class="line">    SDIO_SET_HIGH;       <span class="comment">// 拉高SDIO电平</span></span><br><span class="line">    SCLK_SET_HIGH;       <span class="comment">// 拉高SCLK电平</span></span><br><span class="line">    <span class="keyword">if</span>(two_wired_spi) delay_us(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!two_wired_spi)</span><br><span class="line">    &#123;</span><br><span class="line">        SNCS_SET_LOW;    <span class="comment">// 拉低SNCS电平</span></span><br><span class="line">    &#125;</span><br><span class="line">    delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line"></span><br><span class="line">    write_byte(regAddr);</span><br><span class="line"></span><br><span class="line">    SCLK_SET_LOW;</span><br><span class="line">    sdio_input_mode();</span><br><span class="line">    <span class="keyword">if</span>(two_wired_spi) delay_us(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">else</span> delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line"></span><br><span class="line">    data = read_byte();</span><br><span class="line"></span><br><span class="line">    SCLK_SET_HIGH;</span><br><span class="line">    sdio_output_mode();</span><br><span class="line">    delay_nop(LEVEL_DELAY_SLICES);</span><br><span class="line">    <span class="keyword">if</span>(two_wired_spi) delay_us(<span class="number">40</span>);</span><br><span class="line">    <span class="keyword">else</span> SNCS_SET_HIGH;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="reference">REFERENCE</h1>
<ol type="1">
<li>[【硬件通信协议】5. 实例解析非标准SPI(三线SPI)_sishuihuahua的博客-CSDN博客_三线spi](https://blog.csdn.net/sishuihuahua/article/details/105047926)</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/04/13/Programming/2022-04-13-EIDE-with-VS-Code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/13/Programming/2022-04-13-EIDE-with-VS-Code/" class="post-title-link" itemprop="url">EIDE with VS Code</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-13 18:00:00" itemprop="dateCreated datePublished" datetime="2022-04-13T18:00:00+08:00">2022-04-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-04-15 22:57:36" itemprop="dateModified" datetime="2022-04-15T22:57:36+08:00">2022-04-15</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文主要是将 在KEIL上能够成功编译的 STM32F103VE 芯片项目转移到 VS Code 的 <strong>EIDE</strong> 插件中，主要是针对 Keil MDK-ARM 中的 Option 进行参数复制，即 EIDE 的配置。</p>
<p>需要以下两个工具：</p>
<ul>
<li>Keil MDK-ARM</li>
<li>Keil.STM32F1xx_DFP.2.4.0.pack</li>
</ul>
<p>其实还是依托于 Keil MDK-ARM ，只是换了 VS Code 的皮。</p>
<h1 id="eide-install">EIDE INSTALL</h1>
<p>首先需要在 VS Code 中安装 Embedded IDE（如下），官方手册：<a target="_blank" rel="noopener" href="https://docs.em-ide.com/">EIDE在线文档</a> 。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414214014581.png" alt="image-20220414214014581" /><figcaption aria-hidden="true">image-20220414214014581</figcaption>
</figure>
<h1 id="eide-configuration">EIDE CONFIGURATION</h1>
<p>对 EIDE 的配置主要包括 <a href="##扩展设置">扩展设置</a> 、<a href="##芯片支持包安装">芯片支持包安装</a> 、<a href="##构建参数设置">构建参数设置</a> 和 <a href="##项目属性设置">项目属性设置</a>。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414211312253.png" alt="image-20220414211312253" /><figcaption aria-hidden="true">image-20220414211312253</figcaption>
</figure>
<h2 id="扩展设置">扩展设置</h2>
<p>可以在 VS Code 的插件中选中 <code>Embedded IDE</code> ，在齿轮状设置图标菜单里选择 <code>扩展设置</code>，在里面配置好编译工具链的路径还有一些可设置选项。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414203531929.png" alt="image-20220414203531929" style="zoom:50%;" /></p>
<p>STM32 可以用 ARM CC 和 ARM GCC 进行编译，具体需要看芯片要求，Keil 的话用的是 ARM CC 5版本或者 ARM CC 6 版本。</p>
<p>可以到 Keil MDK-ARM 的安装路径下进行查看，例如 在 <code>D:\Keil_v5\ARM\ARMCC\bin</code> 中，选择右键 <code>用 Powershell 打开</code>，然后输入 <code>./armcc.exe</code> 即可查看版本号。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414183859215.png" alt="image-20220414183859215" style="zoom:50%;" /></p>
<p>主要配置六个参数即可，需要根据本地的 Keil 安装路径来进行设置（不要盲目复制粘贴）。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414203709473.png" alt="image-20220414203709473" style="zoom:50%;" /></p>
<p><img src="https://pic.islet.space/2022/04/image-20220414203744037.png" alt="image-20220414203744037" style="zoom:50%;" /></p>
<h2 id="芯片支持包安装">芯片支持包安装</h2>
<p>Keil 的芯片支持包主要看 <code>Option</code> -&gt; <code>Target</code> 下的 <code>STM32F103xx.svd</code> 。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414194711199.png" alt="image-20220414194711199" style="zoom:50%;" /></p>
<p>通过本地搜索可以看到这个文件需要通过安装 <code>.pack</code> 扩展包得到。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414190916865.png" alt="image-20220414190916865" /><figcaption aria-hidden="true">image-20220414190916865</figcaption>
</figure>
<p>到 <a target="_blank" rel="noopener" href="https://www.keil.com/dd2/Pack/">MDK5 Software Packs (keil.com)</a> 中搜索对应芯片的扩展包，如 <a target="_blank" rel="noopener" href="https://keilpack.azureedge.net/pack/Keil.STM32F1xx_DFP.2.4.0.pack"><code>Keil.STM32F1xx_DFP.2.4.0.pack</code></a> 。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414193428926.png" alt="image-20220414193428926" style="zoom:33%;" /></p>
<p>点击 芯片支持包 右侧的 加号，即可选择通过 <strong>在线安装</strong>（From Repo） 或者 <strong>离线安装</strong>（From Disk）。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414212238565.png" alt="image-20220414212238565" /><figcaption aria-hidden="true">image-20220414212238565</figcaption>
</figure>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414212220319.png" alt="image-20220414212220319" /><figcaption aria-hidden="true">image-20220414212220319</figcaption>
</figure>
<p>安装完扩展包之后 再点击下图中的加号，输入芯片型号进行进一步选择。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414191124478.png" alt="image-20220414191124478" style="zoom: 33%;" /></p>
<p>即可查看芯片的大致信息：</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414190706840.png" alt="image-20220414190706840" style="zoom:33%;" /></p>
<h2 id="构建参数设置">构建参数设置</h2>
<p>构建参数的依据是 Keil 中的这几个参数选项卡：</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414212732414.png" alt="image-20220414212732414" style="zoom:50%;" /></p>
<p>方法：</p>
<ol type="1">
<li>提取 Keil 中的构建参数 （如下 C/C++ 参数设置）</li>
<li>提取 EIDE 中的构建参数</li>
<li>对比差异，以 Keil 为准对 EIDE 进行增删</li>
</ol>
<h3 id="cc-参数设置">C/C++ 参数设置</h3>
<p>下方是 Keil 中对 C/C++ 的构建参数管理页面：</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414200627162.png" alt="image-20220414200627162" style="zoom: 50%;" /></p>
<p>以下是从 Keil MD5 的 <code>Option</code> 中扒下来的编译参数，即最后一行的 <code>Compiler Control String</code> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-c --cpu Cortex-M3 -D__MICROLIB -g -O3 --apcs=interwork --split_sections -I include -I ../ -I ../../../Libraries/CMSIS/CM3/CoreSupport -I ../../../Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x -I ../../../Libraries/STM32F10x_StdPeriph_Driver/inc -I ../../../Utilities/STM32_EVAL -I ../../../Utilities/STM32_EVAL/STM3210B_EVAL -I ../../../Utilities/STM32_EVAL/Common -I ../../STM32F10x_StdPeriph_Template -I ../MDK-ARM</span><br><span class="line">-IF:/Workspace/xiwang_production_test_embedded/Project/STM32F10x_StdPeriph_Template/MDK-ARM/RTE/_STM3210B-EVAL</span><br><span class="line">-ID:/Keil_v5/ARM/PACK/ARM/CMSIS/5.0.0/CMSIS/Include</span><br><span class="line">-ID:/Keil_v5/ARM/PACK/Keil/STM32F1xx_DFP/2.4.0/Device/Include</span><br><span class="line">-D__UVISION_VERSION=<span class="string">&quot;522&quot;</span> -D_RTE_ -DSTM32F10X_HD -DUSE_STDPERIPH_DRIVER -DSTM32F10X_HD -DUSE_STM3210B_EVAL</span><br><span class="line">-o .\build\STM3210B-EVAL\*.o --omf_browse .\build\STM3210B-EVAL\*.crf --depend .\build\STM3210B-EVAL\*.d</span><br></pre></td></tr></table></figure>
<p>以下是从 EIDE 中扒下来的编译命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line">C <span class="built_in">command</span> line (armcc): </span><br><span class="line"></span><br><span class="line">-c --apcs=interwork --cpu Cortex-M3 --li --c99 -D__MICROLIB -O0 --split_sections --diag_suppress=1 --diag_suppress=1295 -g -I.\.. -I.\..\..\..\Libraries\CMSIS\CM3\CoreSupport -I.\..\..\..\Libraries\CMSIS\CM3\DeviceSupport\ST\STM32F10x -I.\..\..\..\Libraries\STM32F10x_StdPeriph_Driver\inc -I.\..\..\..\Utilities\STM32_EVAL -I.\..\..\..\Utilities\STM32_EVAL\STM32100E_EVAL -I.\..\..\..\Utilities\STM32_EVAL\Common -I.\.cmsis\dsp_lib -I.\.cmsis\include -I.\RTE\_STM32100E-EVAL -I.\.eide\deps -I.\include -I.\.eide\deps -DUSE_STDPERIPH_DRIVER -DSTM32F10X_HD_VL -DUSE_STM32100E_EVAL -DGD32F10X_HD</span><br><span class="line"></span><br><span class="line">CPP <span class="built_in">command</span> line (armcc): </span><br><span class="line"></span><br><span class="line">-c --cpp --apcs=interwork --cpu Cortex-M3 --li -D__MICROLIB -O0 --split_sections --diag_suppress=1 --diag_suppress=1295 -g -I.\.. -I.\..\..\..\Libraries\CMSIS\CM3\CoreSupport -I.\..\..\..\Libraries\CMSIS\CM3\DeviceSupport\ST\STM32F10x -I.\..\..\..\Libraries\STM32F10x_StdPeriph_Driver\inc -I.\..\..\..\Utilities\STM32_EVAL -I.\..\..\..\Utilities\STM32_EVAL\STM32100E_EVAL -I.\..\..\..\Utilities\STM32_EVAL\Common -I.\.cmsis\dsp_lib -I.\.cmsis\include -I.\RTE\_STM32100E-EVAL -I.\.eide\deps -I.\include -I.\.eide\deps -DUSE_STDPERIPH_DRIVER -DSTM32F10X_HD_VL -DUSE_STM32100E_EVAL -DGD32F10X_HD</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><strong>EIDE 中查看编译命令的方法</strong>：项目名称右键点击 <code>查看生成的编译器命令行</code> 即可。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414194229852.png" alt="image-20220414194229852" style="zoom:33%;" /></p>
<p>互相比对二者之间的编译参数差异，发现以下差异：</p>
<ol type="1">
<li>Keil 中的代码优化等级为 <code>3</code> 即参数 <code>-O3</code> ，而 EIDE 中为 <code>0</code> 即参数 <code>-O0</code> 。</li>
<li>EIDE 比 Kei多了几个参数 <code>--diag_suppress=1 --diag_suppress=1295</code> ，需要删除。</li>
</ol>
<h3 id="asm-和-linker-参数设置">ASM 和 Linker 参数设置</h3>
<p>对比过 Keil 的参数之后，保持如下设置：</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414213239217.png" alt="image-20220414213239217" /><figcaption aria-hidden="true">image-20220414213239217</figcaption>
</figure>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414213257541.png" alt="image-20220414213257541" /><figcaption aria-hidden="true">image-20220414213257541</figcaption>
</figure>
<h2 id="项目属性设置">项目属性设置</h2>
<h3 id="包含路径设置">包含路径设置</h3>
<p>这个就不多说了。</p>
<p>需要注意的是，RTE路径下的 <code>STM32xxx-EVAL</code> 一定要是正确的，可以多，不要少。</p>
<figure>
<img src="https://pic.islet.space/2022/04/image-20220414213503962.png" alt="image-20220414213503962" /><figcaption aria-hidden="true">image-20220414213503962</figcaption>
</figure>
<h3 id="预处理定义">预处理定义</h3>
<p>从 EIDE 导入 Keil 项目时，可能回设置很多不需要或者错误的 <strong>预处理定义</strong>（宏定义），需要跟 Keil 保持一致。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414213732758.png" alt="image-20220414213732758" style="zoom:50%;" /></p>
<p><img src="https://pic.islet.space/2022/04/image-20220414195358900.png" alt="image-20220414195358900" style="zoom:33%;" /></p>
<h1 id="debug-records">DEBUG RECORDS</h1>
<h2 id="expected-a">EXPECTED A }</h2>
<p>提示 少了 <code>&#125;</code> ，该文件是官方文件，应该不会错。经过检查，发现是宏定义过多导致的错误，修改过 <a href="###预处理定义">预处理定义</a> 中的宏定义设置就解决了。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414190748098.png" alt="image-20220414190748098" style="zoom:33%;" /></p>
<p>如下，<code>STM32F10X_HD</code> 和 <code>STM32F10X_HD_VL</code> 冲突了。</p>
<p><img src="https://pic.islet.space/2022/04/image-20220414194044509.png" alt="image-20220414194044509" style="zoom:50%;" /></p>
<p>最后，编译结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[ INFO ] start building at 2022-04-14 20:22:39</span><br><span class="line"></span><br><span class="line">[ TOOL ] ARM Compiler 5.06 update 4 (build 422)</span><br><span class="line"></span><br><span class="line">[ INFO ] file statistics (rebuild mode)</span><br><span class="line"></span><br><span class="line">+---------+-----------+-----------+-----------+--------+</span><br><span class="line">| C Files | Cpp Files | Asm Files | Lib Files | Totals |</span><br><span class="line">+---------+-----------+-----------+-----------+--------+</span><br><span class="line">| 46      | 0         | 1         | 0         | 47     |</span><br><span class="line">+---------+-----------+-----------+-----------+--------+</span><br><span class="line"></span><br><span class="line">[ INFO ] start compilation (<span class="built_in">jobs</span>: 4) ...</span><br><span class="line"></span><br><span class="line">&gt;&gt; [  2%] CC <span class="string">&#x27;../../../Libraries/CMSIS/CM3/CoreSupport/core_cm3.c&#x27;</span></span><br><span class="line">&gt;&gt; [  4%] CC <span class="string">&#x27;main.c&#x27;</span></span><br><span class="line">&gt;&gt; [  6%] CC <span class="string">&#x27;../../../Libraries/STM32F10x_StdPeriph_Driver/src/stm32f10x_flash.c&#x27;</span></span><br><span class="line">&gt;&gt; [  8%] CC <span class="string">&#x27;../../../Libraries/STM32F10x_StdPeriph_Driver/src/stm32f10x_usart.c&#x27;</span></span><br><span class="line">......</span><br><span class="line">&gt;&gt; [ 89%] CC <span class="string">&#x27;source/stm32f10x_it.c&#x27;</span></span><br><span class="line">&gt;&gt; [ 91%] CC <span class="string">&#x27;../../../Utilities/STM32_EVAL/STM32100E_EVAL/stm32100e_eval_lcd.c&#x27;</span></span><br><span class="line">&gt;&gt; [ 93%] CC <span class="string">&#x27;source/system_stm32f10x.c&#x27;</span></span><br><span class="line">&gt;&gt; [ 95%] CC <span class="string">&#x27;../../../Utilities/STM32_EVAL/stm32_eval.c&#x27;</span></span><br><span class="line">&gt;&gt; [ 97%] CC <span class="string">&#x27;source/write.c&#x27;</span></span><br><span class="line">&gt;&gt; [100%] AS <span class="string">&#x27;../../../Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/startup/arm/startup_stm32f10x_hd_vl.s&#x27;</span></span><br><span class="line"></span><br><span class="line">[ INFO ] start linking ...</span><br><span class="line"></span><br><span class="line">Program Size: Code=9028 RO-data=340 RW-data=156 ZI-data=1412  </span><br><span class="line"></span><br><span class="line">Total RO  Size (Code + RO Data)                 9368 (   9.15kB)</span><br><span class="line">Total RW  Size (RW Data + ZI Data)              1568 (   1.53kB)</span><br><span class="line">Total ROM Size (Code + RO Data + RW Data)       9524 (   9.30kB)</span><br><span class="line"></span><br><span class="line">RAM  : [          ] 2.4%        1.5KB/64.0KB</span><br><span class="line">FLASH: [          ] 1.8%        9.3KB/512.0KB</span><br><span class="line"></span><br><span class="line">[ INFO ] start outputting file ...</span><br><span class="line"></span><br><span class="line">&gt;&gt; output hex file              [<span class="keyword">done</span>]</span><br><span class="line"></span><br><span class="line">file path: <span class="string">&quot;build/STM32100E-EVAL/FT_Test.hex&quot;</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; output s19 file              [<span class="keyword">done</span>]</span><br><span class="line"></span><br><span class="line">file path: <span class="string">&quot;build/STM32100E-EVAL/FT_Test.s19&quot;</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; output bin file              [<span class="keyword">done</span>]</span><br><span class="line"></span><br><span class="line">file path: <span class="string">&quot;build/STM32100E-EVAL/FT_Test.bin&quot;</span></span><br><span class="line"></span><br><span class="line">[ DONE ] build successfully !, elapsed time 0:0:9</span><br><span class="line"></span><br><span class="line">[ INFO ] run tasks after build ...</span><br><span class="line"></span><br><span class="line">&gt;&gt; axf to elf           [<span class="keyword">done</span>]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/03/26/Programming/2022-03-26-matplotlib%E5%9B%BE%E5%BD%A2%E7%BB%98%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/26/Programming/2022-03-26-matplotlib%E5%9B%BE%E5%BD%A2%E7%BB%98%E5%88%B6/" class="post-title-link" itemprop="url">matplotlib图形绘制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-26 15:00:00" itemprop="dateCreated datePublished" datetime="2022-03-26T15:00:00+08:00">2022-03-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-04-15 22:57:36" itemprop="dateModified" datetime="2022-04-15T22:57:36+08:00">2022-04-15</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>类似于 gnuplot ， matplotlib 也是开源的图形绘制软件。</p>
<p>需要使用到的工具如下：</p>
<ul>
<li>Jupyter：python 分布调试 和 Markdown 笔记记录一体化工具。</li>
<li>Python3.10</li>
<li>Python3 插件： matplotlib / pandas</li>
<li>VS code 所需插件： pylance</li>
</ul>
<p>其中， matplotlib 是绘图所用的开源工具库，而 pandas 是文档管理的 “瑞士军刀”。</p>
<h1 id="环境安装">环境安装</h1>
<h2 id="jupyter-安装">JUPYTER 安装</h2>
<p>Jupyter可以支持在线和离线使用，在线即以网页形式支持使用，可以在服务器上进行部署。离线即在 Visual Studio Code 中以插件形式提供安装和使用。</p>
<h3 id="在线安装">在线安装</h3>
<p>以 Ubuntu 系统为例，可以用 <code>apt</code> 进行安装，也可以用 <code>pip</code> （或 <code>pip3</code> ）进行安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install jupyter</span><br></pre></td></tr></table></figure>
<p>在线版 Jupyter 还需要安装一个 <code>ipyparallel</code> 的类：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install ipyparallel</span><br><span class="line">ipcluster start</span><br></pre></td></tr></table></figure>
<h4 id="远程访问配置项">远程访问配置项</h4>
<p>参考 《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wu-chao/p/8419889.html">ubuntu 安装Juypter并设置远程访问</a>》对 服务器端 Jupyter进行设置和访问测试。</p>
<p>相关防火墙设置 / 证书 / 域名 不再赘述。</p>
<h4 id="自启动配置">自启动配置</h4>
<p>另外，Linux 服务器端 Jupyter 用 <code>jupyter notebook</code> 命令启动，无法开机自启，需要参考 《<a target="_blank" rel="noopener" href="https://blog.csdn.net/initiallht/article/details/122029888">Linux下Jupyter开机启动设置</a>》 进行设置。</p>
<p>设置好后 在线版 Jupyter 编辑器的页面如下：</p>
<figure>
<img src="https://pic.islet.space/2022/03/image-20220327165129680.png" alt="在线使用界面" /><figcaption aria-hidden="true">在线使用界面</figcaption>
</figure>
<h3 id="离线安装">离线安装</h3>
<p>在 VS code 插件中搜索并安装第一个 <code>Jupyter</code> 即可，插件系统会自动安装下面附带的 <code>Jupyter Keymap</code> 和 <code>Jupyter Notebook Renderers</code> 两个插件。</p>
<figure>
<img src="https://pic.islet.space/2022/03/image-20220327163752153.png" alt="image-20220327163752153" /><figcaption aria-hidden="true">image-20220327163752153</figcaption>
</figure>
<p>安装完之后，需要新建一个 <code>.ipynb</code> 格式的文件，即可自动打开 <code>Jupyter</code> 插件进行使用。</p>
<figure>
<img src="https://pic.islet.space/2022/03/image-20220327165214773.png" alt="离线使用界面" /><figcaption aria-hidden="true">离线使用界面</figcaption>
</figure>
<h2 id="pip-依赖库安装">PIP 依赖库安装</h2>
<p>在线版和离线版都需要使用 terminal 打开并输入命令进行安装下方的依赖库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install matplotlib pandas</span><br></pre></td></tr></table></figure>
<h1 id="图形生成代码">图形生成代码</h1>
<p>下方利用 pandas 类对 <code>.csv</code> 文件中的相关列进行数据提取，然后利用 matplotlib 类对 数据进行绘图。</p>
<p>因功能比较简单，不再赘述。</p>
<p>具体需要注意的事项已在代码注释中写明。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入依赖库</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入工具</span></span><br><span class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> Series,DataFrame</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> matplotlib.font_manager <span class="keyword">import</span> FontProperties</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置csv表格中的行信息</span></span><br><span class="line">column=[<span class="string">&quot;ts&quot;</span>,<span class="string">&quot;dx&quot;</span>,<span class="string">&quot;dy&quot;</span>,<span class="string">&quot;motion&quot;</span>,<span class="string">&quot;iqc&quot;</span>,<span class="string">&quot;shutter&quot;</span>,<span class="string">&quot;frame_avg&quot;</span>,<span class="string">&quot;status&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置文件路径</span></span><br><span class="line">csv_file_path = <span class="string">&#x27;../data/&#x27;</span></span><br><span class="line">pic_file_path = <span class="string">&#x27;../pic/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入和输出文件名</span></span><br><span class="line">file = <span class="string">&#x27;20220327_135012&#x27;</span></span><br><span class="line">csv_file_name = file + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">pic_file_name = file + <span class="string">&#x27;.jpg&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置各轴及标题标签</span></span><br><span class="line">chart_title = <span class="string">&#x27;A4 data collection in stm32l476rg&#x27;</span></span><br><span class="line">x_label = <span class="string">&#x27;time(ms)&#x27;</span></span><br><span class="line">y_label = <span class="string">&#x27;data collected&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置各线段标签</span></span><br><span class="line">line_1_label = <span class="string">&#x27;dx&#x27;</span></span><br><span class="line">line_2_label = <span class="string">&#x27;dy&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置线段透明度</span></span><br><span class="line">line_1_alpha = <span class="number">0.5</span></span><br><span class="line">line_2_alpha = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置线段类型</span></span><br><span class="line"><span class="comment"># 可选 scatter 和 line</span></span><br><span class="line">plot_type = <span class="string">&#x27;scatter&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>]=[<span class="string">&#x27;YAHEI&#x27;</span>]</span><br><span class="line"><span class="comment"># 用于正常显示正负号</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>]=<span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义空列表存放xy轴数据点</span></span><br><span class="line">x = []</span><br><span class="line">y = []</span><br><span class="line">z = []</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># 可以使用open()方法对csv文件进行读取</span></span><br><span class="line"><span class="string"># 但是暂时没有找到可以避免读取到头部信息的方法，即不能跳过部分数据进行读取</span></span><br><span class="line"><span class="string">with open( csv_file_path + csv_file_name, &#x27;r&#x27;, encoding=&#x27;utf8&#x27;) as csv_file:</span></span><br><span class="line"><span class="string">    plots = csv.reader(csv_file, delimiter=&#x27;,&#x27;)</span></span><br><span class="line"><span class="string">    for row in plots:</span></span><br><span class="line"><span class="string">        x.append(int(row[0]))</span></span><br><span class="line"><span class="string">        y.append(int(row[1]))</span></span><br><span class="line"><span class="string">        z.append(int(row[2]))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用panda的read_csv()方法可以设置跳过部分数据进行处理</span></span><br><span class="line">csv_file = pd.read_csv(csv_file_path + csv_file_name, </span><br><span class="line">                       skiprows=<span class="number">21</span>,</span><br><span class="line">                       delimiter=<span class="string">&#x27;,&#x27;</span>, </span><br><span class="line">                       names=column) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 将对应列数据放入变量中</span></span><br><span class="line">x = csv_file[<span class="string">&#x27;ts&#x27;</span>]</span><br><span class="line">y = csv_file[<span class="string">&#x27;dx&#x27;</span>]</span><br><span class="line">z = csv_file[<span class="string">&#x27;dy&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置线段标签</span></span><br><span class="line"><span class="keyword">if</span>( plot_type==<span class="string">&#x27;line&#x27;</span>):</span><br><span class="line">    plt.plot(x,y, label=line_1_label, alpha=line_1_alpha, lw=<span class="number">1</span>)</span><br><span class="line">    plt.plot(x,z, label=line_2_label, alpha=line_2_alpha, lw=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">elif</span>( plot_type == <span class="string">&#x27;scatter&#x27;</span>):</span><br><span class="line">    plt.scatter(x,y, label=line_1_label, alpha=line_1_alpha, s=<span class="number">1</span>)</span><br><span class="line">    plt.scatter(x,z, label=line_2_label, alpha=line_2_alpha, s=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置x轴、y轴和标题标签</span></span><br><span class="line">plt.xlabel(x_label)</span><br><span class="line">plt.ylabel(y_label)</span><br><span class="line">plt.title(chart_title)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示图像</span></span><br><span class="line">plt.legend()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 图像保存</span></span><br><span class="line">plt.savefig( pic_file_path + pic_file_name , dpi=<span class="number">400</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<h1 id="使用方法">使用方法</h1>
<ol type="1">
<li>生成一个文件夹，下面包含三个并行子路径。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">├── data</span><br><span class="line">├── pic</span><br><span class="line">└── src</span><br></pre></td></tr></table></figure>
<p>网页版：</p>
<figure>
<img src="https://pic.islet.space/2022/03/image-20220327164922369.png" alt="网页版文件结构示意" /><figcaption aria-hidden="true">网页版文件结构示意</figcaption>
</figure>
<ol start="2" type="1">
<li>将代码放到 <code>src/</code> 中，在将代码第19行中的 <code>file = '20220327_135012'</code> 文件名进行修改，确保其与 <code>data/</code> 路径下的 <code>.csv</code> 文件名成可以对上。</li>
<li>执行整段代码，即可在 <code>pic/</code> 文件夹下找到对应的图像文件。</li>
</ol>
<h1 id="reference">REFERENCE</h1>
<ol type="1">
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/378378346">vscode写jupyter notebook</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/129004421">Pandas将csv数据拆分成多列并保存</a></p></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/02/24/Hardware/STM32/2022-02-22-%E5%9C%A8mac%E4%B8%8A%E5%AE%89%E8%A3%85stm32CubeMX/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/24/Hardware/STM32/2022-02-22-%E5%9C%A8mac%E4%B8%8A%E5%AE%89%E8%A3%85stm32CubeMX/" class="post-title-link" itemprop="url">在mac上安装stm32CubeMX</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-24 02:00:00" itemprop="dateCreated datePublished" datetime="2022-02-24T02:00:00+08:00">2022-02-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-02-23 00:06:22" itemprop="dateModified" datetime="2022-02-23T00:06:22+08:00">2022-02-23</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="tools-download-and-setup">TOOLS DOWNLOAD AND SETUP</h1>
<p>在 ST 官网下载了 CubeMX 的 Mac 版软件，然后会发现关闭安全相关的限制也没办法打开该软件包。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222205346872.png" alt="image-20220222205346872" /><figcaption aria-hidden="true">image-20220222205346872</figcaption>
</figure>
<p>通过 <code>tree</code> 命令查看目录可以找到一个叫 <code>SetupSTM32CubeMX-6_3_0</code> 的应用程序，运行该文件即可进行安装。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222205452868.png" alt="image-20220222205452868" /><figcaption aria-hidden="true">image-20220222205452868</figcaption>
</figure>
<p>Mac 系统上可运行的程序都是 <code>.App</code> 结尾的文件夹，直接点击右键的 <code>显示包内容</code> 即可进入查看。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222205524560.png" alt="image-20220222205524560" /><figcaption aria-hidden="true">image-20220222205524560</figcaption>
</figure>
<p>双击 <code>SetupSTM32CubeMX-6_3_0</code> 即可运行安装程序。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222205545346.png" alt="image-20220222205545346" /><figcaption aria-hidden="true">image-20220222205545346</figcaption>
</figure>
<h1 id="new-project">NEW PROJECT</h1>
<p>在 CubeMX 的 Home 界面，可以 <strong>根据芯片型号新建项目</strong>，也可以 <strong>根据ST板子型号新建项目</strong>。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222213510204.png" alt="image-20220222213510204" /><figcaption aria-hidden="true">image-20220222213510204</figcaption>
</figure>
<p>只需要在对应需要的 MCU 或者 板子上双击即可。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222213140557.png" alt="image-20220222213140557" /><figcaption aria-hidden="true">image-20220222213140557</figcaption>
</figure>
<p>如果使用ST自家的评估板，新建项目时建议直接选择 <code>ACCESS TO BOARD SELECTOR</code> 。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222212802407.png" alt="image-20220222212802407" /><figcaption aria-hidden="true">image-20220222212802407</figcaption>
</figure>
<p>它会帮助默认设置一些板子上的外设（它会提示 <code>Initialize all peripherals with their default Mode?</code> ），就不用用户自己去设置，否则选择 <code>ACCESS TO MCU SELECTOR</code> 就会在某些地方上产生默认配置差异，如 GPIO。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222213201459.png" alt="image-20220222213201459" /><figcaption aria-hidden="true">image-20220222213201459</figcaption>
</figure>
<p>下图为根据 ST 板子型号生成项目时默认配置的一些外设引脚。当然，还需要自行设置各个需要使用到的引脚的具体配置，如输入/输出、拉高/拉低等等。</p>
<p><img src="https://pic.islet.space/2022/02/image-20220222213417943.png" alt="image-20220222213417943" style="zoom:33%;" /></p>
<p>下图为根据 ST 芯片信号生成项目时默认不配置任何引脚：</p>
<p><img src="https://pic.islet.space/2022/02/image-20220222213744404.png" alt="image-20220222213744404" style="zoom:33%;" /></p>
<h1 id="debug-records">DEBUG RECORDS</h1>
<h2 id="attempt-to-rename-spec-link-to-already-defined-spec-nano_link">ATTEMPT TO RENAME SPEC 'LINK' TO ALREADY DEFINED SPEC 'NANO_LINK'</h2>
<p><code>cmake .. ; make</code> 时发现 <code>cmake</code> 无误，而 <code>make</code> 报错，提示 <code>attempt to rename sepc 'link' to already defined spec 'nano_link'</code>。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222224906371.png" alt="image-20220222224906371" /><figcaption aria-hidden="true">image-20220222224906371</figcaption>
</figure>
<p>具体报错信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fatal error: &#x2F;Users&#x2F;liewzheng&#x2F;bin&#x2F;gcc-arm-none-eabi-5_4-2016q3&#x2F;bin&#x2F;..&#x2F;lib&#x2F;gcc&#x2F;arm-none-eabi&#x2F;5.4.1&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;arm-none-eabi&#x2F;lib&#x2F;nano.specs: attempt to rename spec &#39;link&#39; to already defined spec &#39;nano_link&#39;</span><br><span class="line">compilation terminated.</span><br><span class="line">make[2]: *** [led_blink.elf] Error 1</span><br><span class="line">make[1]: *** [CMakeFiles&#x2F;led_blink.elf.dir&#x2F;all] Error 2</span><br><span class="line">make: *** [all] Error 2</span><br></pre></td></tr></table></figure>
<p>而 <code>CMakeLists.txt</code> 文件中只有以下此句设计 <code>spec</code> 和 <code>nano</code> 关键字（下方注释是后来加上去的），此配置在 linux 平台上是运行正常的。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果提示 linker 相关的错误，请删除  `-specs=nosys.specs` 和 `-specs=nano.specs` 这两个标志及所在临时文件夹并再次 `cmake .. ; make` 进行尝试</span></span><br><span class="line"><span class="keyword">SET</span>(CPU <span class="string">&quot;-mcpu=cortex-m4&quot;</span>)</span><br><span class="line"><span class="keyword">SET</span>(FPU <span class="string">&quot;-mfpu=fpv4-sp-d16&quot;</span>)</span><br><span class="line"><span class="keyword">SET</span>(FLOAT_ABI <span class="string">&quot;-mfloat-abi=hard&quot;</span>)</span><br><span class="line"><span class="keyword">SET</span>(MCU <span class="string">&quot;$&#123;CPU&#125; -mthumb $&#123;FPU&#125; $&#123;FLOAT_ABI&#125;&quot;</span> --specs=nosys.specs -specs=nano.specs)</span><br></pre></td></tr></table></figure>
<h3 id="解决方法">解决方法</h3>
<p>根据 <a target="_blank" rel="noopener" href="https://community.st.com/s/question/0D50X00009XkWJiSAN/building-error-from-imported-stm32cubemx-project">Building Error from imported STM32CubeMX project</a> 的解决方法，删除 <code>-specs=nosys.specs</code> 和 <code>-specs=nano.specs</code> 这两个连接器的标志即可编译通过。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222230947465.png" alt="image-20220222230947465" /><figcaption aria-hidden="true">image-20220222230947465</figcaption>
</figure>
<p>删除该两个标志后，<code>MCU</code> 变量为 <code>SET(MCU "$&#123;CPU&#125; -mthumb $&#123;FPU&#125; $&#123;FLOAT_ABI&#125;"</code>。</p>
<h2 id="warning-cannot-find-entry-symbol-arch_paths_first">WARNING: CANNOT FIND ENTRY SYMBOL ARCH_PATHS_FIRST</h2>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220222235232398.png" alt="image-20220222235232398" /><figcaption aria-hidden="true">image-20220222235232398</figcaption>
</figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/02/24/Linux/Server/2022-02-24-Jenkins%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/24/Linux/Server/2022-02-24-Jenkins%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">Jenkins服务器部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-02-24 00:30:00 / Modified: 19:32:16" itemprop="dateCreated datePublished" datetime="2022-02-24T00:30:00+08:00">2022-02-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文只涉及 Jenkins 在 Debian Linux (Kali) 下的相关安装，不涉及使用教程，关于Jenkins的相关科普请自行搜。</p>
<h1 id="jenkins安装">Jenkins安装</h1>
<p>Jenkins 可以通过两种方式运行：</p>
<ul>
<li>通过官网下载 <code>http://mirrors.jenkins.io/war-stable/latest/jenkins.war</code> 程序，并确保安装了 <code>openjdk-8</code> 即可。此种方式是直接运行 <code>.war</code> 的软件的，免安装，但基于 <code>ssh</code> 远程连接的用户断开连接之后可能会导致无法运行。即，如果不知道如何正确操作shell以便在后台运行该免安装程序，就不推荐使用。</li>
<li>另一种是安装版本，仍然需要用户提前先安装好 <code>openjdk-8</code> ，然后通过 <a target="_blank" rel="noopener" href="https://pkg.jenkins.io/debian/">官网教程</a> 来添加源和使用 <code>apt</code> 命令进行安装。这种方式可以使用 <code>systemctl</code> 命令确保 Jenkins 开机自启动并在后台运行。</li>
</ul>
<h2 id="java-setup">JAVA SETUP</h2>
<p>需要注意的是，jre有 oracle 版本和 openjdk 版本，需要安装后者。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update ; sudo apt upgrade ; sudo apt install openjdk-8-jre</span><br></pre></td></tr></table></figure>
<p>将 <code>JAVA_HOME</code> 写到你对应的 shell 配置文件中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-1.8.0-openjdk-amd64</span><br><span class="line">export CLASSPATH&#x3D;$JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;rt.jar:$JAVA_HOME&#x2F;lib&#x2F;dt.jar:$JAVA_HOME&#x2F;lib&#x2F;tools.jar</span><br><span class="line">export PATH&#x3D;$JAVA_HOME&#x2F;bin:$PATH</span><br></pre></td></tr></table></figure>
<h2 id="免安装运行">免安装运行</h2>
<p>下面就是使用 <code>java -jar jenkins.war --httpPort=8080</code> 命令来免安装运行的。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220224003818560.png" alt="image-20220224003818560" /><figcaption aria-hidden="true">image-20220224003818560</figcaption>
</figure>
<h2 id="安装运行">安装运行</h2>
<p>实际上，直接运行下面的 <code>sudo apt install openjdk-11-jre</code> 可能会导致无法运行，原因不明，还是推荐自行使用 <code>sudo apt install openjdk-8-jre</code> 进行安装。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220224191828341.png" alt="image-20220224191828341" /><figcaption aria-hidden="true">image-20220224191828341</figcaption>
</figure>
<h2 id="防火墙配置">防火墙配置</h2>
<p>这一点就不再赘述了。</p>
<ol type="1">
<li><strong>开启系统内端口</strong>：用 <code>iptables</code> 参考 《<a href="https://islet.space/2019/03/05/Linux/SSH/CentOS7%E5%AE%89%E8%A3%85iptables%E9%98%B2%E7%81%AB%E5%A2%99/">CentOS7安装iptables防火墙</a>》，注意看后面评论内容。</li>
<li><strong>开启控制台端口</strong>：配置为云服务器的要去网页界面的控制台将对应端口打开。</li>
</ol>
<h1 id="jenkins配置">Jenkins配置</h1>
<p>安装完毕之后，在浏览器中输入 对应网址的 <code>8080</code> 端口，进入页面后输入管理员密码。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220224003852043.png" alt="image-20220224003852043" /><figcaption aria-hidden="true">image-20220224003852043</figcaption>
</figure>
<p>选择新手入门配置安装插件。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220224003716199.png" alt="image-20220224003716199" /><figcaption aria-hidden="true">image-20220224003716199</figcaption>
</figure>
<p>安装完毕之后就会让你设置管理员账户。</p>
<p>虽然，java11是推荐安装，可我就是运行失败。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220224004120934.png" alt="image-20220224004120934" /><figcaption aria-hidden="true">image-20220224004120934</figcaption>
</figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/02/23/Linux/2022-02-23-%E8%87%AA%E5%BB%BAgit%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/23/Linux/2022-02-23-%E8%87%AA%E5%BB%BAgit%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/" class="post-title-link" itemprop="url">自建git远程仓库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-02-23 01:45:00 / Modified: 21:18:15" itemprop="dateCreated datePublished" datetime="2022-02-23T01:45:00+08:00">2022-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>基本上也就只参考了廖雪峰这篇 《 <a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/896043488029600/899998870925664">搭建Git服务器</a> 》 的文章。</p>
<h1 id="部署git服务器">部署git服务器</h1>
<h2 id="确保已安装git">确保已安装git</h2>
<p>for debian linux:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git </span><br></pre></td></tr></table></figure>
<p>and check the version of it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git --version</span><br></pre></td></tr></table></figure>
<h2 id="创建git账户">创建git账户</h2>
<p>Add a account name <code>git</code> in linux :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo adduser git</span><br></pre></td></tr></table></figure>
<h2 id="设置使用者的ssh配置">设置使用者的SSH配置</h2>
<p>Copy the SSH keys of your client computers to save to the file in <code>/home/git/.ssh/authorized_keys</code> .</p>
<h2 id="禁用shell登录">禁用shell登录</h2>
<p>For the safety of your server, you should ban the shell login for <code>git</code> account.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/passwd</span><br></pre></td></tr></table></figure>
<p>Find something like <code>git:x:1001:1001:,,,:/home/git:/bin/bash</code> , and modify it to:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git:x:1001:1001:,,,:/home/git:/usr/bin/git-shell</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>git</code>用户可以正常通过ssh使用git，但无法登录shell，因为已经为<code>git</code>用户指定的<code>git-shell</code>每次一登录就自动退出。</p>
</blockquote>
<h1 id="新建仓库">新建仓库</h1>
<ul>
<li>Build a directory named <code>srv</code> to store the repositories. (Of course you can name it the way you like.)</li>
<li>Initializa a new bare repository name <code>xxx</code>.</li>
<li>Change its owner as the user <code>git</code> which is just created before.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /srv/</span><br><span class="line">sudo git init --bare /srv/xxxx.git</span><br><span class="line">sudo chown -R git:git /srv/xxxx.git</span><br></pre></td></tr></table></figure>
<p>And you can copy the script below TO CREATE YOUR NEW REPOSITY. Remember to save it as <code>.sh</code> file and use <code>chmod +x</code> command to make it executable.</p>
<blockquote>
<p>By default, this script is stored as <code>gitInit.sh</code> in the diretory <code>/srv</code>.</p>
<p>If you change the script execute diretory, remember to modify the script below.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GIT_REPOSITORY=<span class="variable">$1</span></span><br><span class="line">sudo git init --bare <span class="variable">$GIT_REPOSITORY</span>.git</span><br><span class="line">sudo chown -R git:git <span class="variable">$GIT_REPOSITORY</span>.git</span><br></pre></td></tr></table></figure>
<p>USAGE:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gitInit.sh &lt;newRepository&gt;</span><br></pre></td></tr></table></figure>
<h1 id="使用仓库">使用仓库</h1>
<p>到这一步为止，已经可以使用 <code>git pull git@&lt;yourServer&gt;:/srv/xxx.git</code> 进行仓库拉取了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@&lt;yourServer&gt;:/srv/sample.git</span><br></pre></td></tr></table></figure>
<p>And you will see:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cloning into <span class="string">&#x27;sample&#x27;</span>...</span><br><span class="line">warning: You appear to have cloned an empty repository.</span><br></pre></td></tr></table></figure>
<p>如果需要添加一个固定的远程仓库，需要使用到 <code>url</code> ，即需要开启了 <code>443</code> 端口的服务器。</p>
<h1 id="其他服务器管理">其他服务器管理</h1>
<h2 id="证书颁发">证书颁发</h2>
<p>如下所示，下面的子域名已经签审了 SSL 证书了，可以正常使用 <code>443</code> 端口不被拒绝。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220223015715136.png" alt="image-20220223015715136" /><figcaption aria-hidden="true">image-20220223015715136</figcaption>
</figure>
<h2 id="防火墙设置">防火墙设置</h2>
<p>确保腾讯云服务器管理页面下的防火墙设置中已开启 <code>443</code> 端口。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220223015852398.png" alt="image-20220223015852398" /><figcaption aria-hidden="true">image-20220223015852398</figcaption>
</figure>
<p>使用 ubuntu 和 centos 系统的可以参考 《<a href="https://islet.space/2019/03/05/Linux/SSH/CentOS7%E5%AE%89%E8%A3%85iptables%E9%98%B2%E7%81%AB%E5%A2%99/#%E4%B8%89-%E8%AE%BE%E7%BD%AE%E7%8E%B0%E6%9C%89%E8%A7%84%E5%88%99">CentOS7安装iptables防火墙</a>》 开启 <code>443</code> 端口，直接运行下面命令即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="克隆远程仓库">克隆远程仓库</h2>
<p>如果本地已有仓库，可能会与远程服务器的 <code>master</code> 分支冲突，需要自行使用 <code>git fetch</code> 管理，然后使用 <code>git push --set-upstream master</code> 进行上传。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220223014741138.png" alt="image-20220223014741138" /><figcaption aria-hidden="true">image-20220223014741138</figcaption>
</figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/02/22/Macintosh/2022-02-22-%E6%9B%B4%E6%94%B9mac%E7%9A%84%E9%BB%98%E8%AE%A4shell%E4%B8%BAfish/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/22/Macintosh/2022-02-22-%E6%9B%B4%E6%94%B9mac%E7%9A%84%E9%BB%98%E8%AE%A4shell%E4%B8%BAfish/" class="post-title-link" itemprop="url">更改Mac的默认shell为fish</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-22 20:50:00" itemprop="dateCreated datePublished" datetime="2022-02-22T20:50:00+08:00">2022-02-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-02-23 00:17:11" itemprop="dateModified" datetime="2022-02-23T00:17:11+08:00">2022-02-23</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Macintosh/" itemprop="url" rel="index"><span itemprop="name">Macintosh</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Mac 平台自带的 zsh 真的极不好用，同样是 unix-like 平台，跟 kali 平台上的 zsh 体验相差甚远。 一直都是黑白配色，而且修改中断和配置的动手能力确实没有那么强。偶然适用了一下 <code>fish</code> ，发现在 Mac 平台使用效果挺好的，就决定进行更换。切换成黑色背景后更为舒适了，之前一直使用瞎眼的白色。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220223001619177.png" alt="image-20220223001619177" /><figcaption aria-hidden="true">image-20220223001619177</figcaption>
</figure>
<h1 id="fish-setup">FISH SETUP</h1>
<p>我安装了 MacPorts 包管理工具，直接用 <code>port</code> 命令即可安装 <code>fish</code> 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo port install fish</span><br></pre></td></tr></table></figure>
<h1 id="add-fish-to-etcshells">ADD FISH TO /etc/shells</h1>
<p>使用 <code>which fish</code> 可以调出 <code>fish</code> 的安装路径（用 <code>port</code> 安装的话默认路径是 <code>/opt/local/bin/fish</code> ），复制该路径，然后粘贴到 <code>/etc/shells</code> 文件末尾。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/shells</span><br></pre></td></tr></table></figure>
<p><strong>NOTE</strong>：千万不要用 <code>sudo vim /etc/shells</code> 这样会修改到 <code>root</code> 管理员角色的 shell （如果出问题就会很麻烦），用户自己折腾自己的 shell 就好了。</p>
<p>通过 <code>cat /etc/shells</code> 可以查看所有可供使用的 shell 。</p>
<h1 id="change-default-shell">CHANGE DEFAULT SHELL</h1>
<p>使用 <code>chsh</code> 语句即可将 <code>fish</code> 设置为默认 shell 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chsh -s /opt/<span class="built_in">local</span>/bin/fish</span><br></pre></td></tr></table></figure>
<h1 id="note">NOTE</h1>
<p><code>fish</code> 所使用的配置文件并非 <code>~/.fish</code> 而是 <code>~/.bash_profile</code> ，在里面修改完内容可以 <code>source</code> 该文件进行立即更新。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/01/28/Linux/System/2022-01-28-Kali-%E4%B8%8E-MBA-2015/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/28/Linux/System/2022-01-28-Kali-%E4%B8%8E-MBA-2015/" class="post-title-link" itemprop="url">Kali 与 MBA-2015</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-28 12:00:00" itemprop="dateCreated datePublished" datetime="2022-01-28T12:00:00+08:00">2022-01-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-02-23 00:20:06" itemprop="dateModified" datetime="2022-02-23T00:20:06+08:00">2022-02-23</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="网卡驱动安装">网卡驱动安装</h1>
<p>Macbook Air 2015年 13英寸版所使用的的网卡是 博通的 <code>BCM94360CS2</code> 。</p>
<p>可以从 <code>关于本机</code> --&gt; <code>系统报告</code> --&gt; <code>Wi-Fi</code> 中查看到硬件固件版本。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220128154108052.png" alt="image-20220128154108052" /><figcaption aria-hidden="true">image-20220128154108052</figcaption>
</figure>
<p>安装完Linux之后，暂时无法联网，需要使用有线网络进行上网，可以使用 iPhone 接 <code>lighting-USBA</code> 的转接线进行上网，然后使用 <code>apt</code> 命令下载安装 <code>bcmwl-kernel-source</code> 。</p>
<p>如果使用 <code>pkgs.org</code> 官网上下载的 <code>bcmwl-kernel-source.dpkg</code> 则会提示缺少很多依赖，无法直接一步安装到位。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220128154312606.png" alt="image-20220128154312606" /><figcaption aria-hidden="true">image-20220128154312606</figcaption>
</figure>
<h1 id="apfs-硬盘内容读取">APFS 硬盘内容读取</h1>
<p><code>https://github.com/sgan81/apfs-fuse/</code></p>
<h1 id="reference">REFERENCE</h1>
<ol type="1">
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lovesKey/p/10791914.html">在linux访问macos下的分区</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/01/25/Computer/2022-01-25-repo-and-git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/25/Computer/2022-01-25-repo-and-git/" class="post-title-link" itemprop="url">repo and git</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-25 11:15:00" itemprop="dateCreated datePublished" datetime="2022-01-25T11:15:00+08:00">2022-01-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-02-26 22:53:24" itemprop="dateModified" datetime="2022-02-26T22:53:24+08:00">2022-02-26</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer/" itemprop="url" rel="index"><span itemprop="name">Computer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本博文并不提供全面的教学指导，详细手册请查阅 <a target="_blank" rel="noopener" href="https://git-scm.com/docs/">Git-Reference</a> 和 <a target="_blank" rel="noopener" href="https://source.android.google.cn/source/developing?hl=zh-cn#staging-files">开发</a> 。</p>
<p><code>Git</code> 是一个开放源代码的版本控制系统，专用于处理分布在多个代码库上的大型项目。</p>
<p><code>Repo</code> 是 google android 以 <code>Git</code> 为基础构建的代码库管理工具，依赖于 <code>python2</code> 脚本调用 Git，主要用来下载、管理android项目的软件仓库。</p>
<p><code>Repo</code> 简化了跨多个代码库运行的流程，与 <code>Git</code> 相辅相成。Repo 可以在必要时 <mark style="font-weight: 900;">整合多个 Git 代码库，将相关内容上传到我们的修订版本控制系统</mark>，借助单个 Repo 命令，<mark style="font-weight: 900;">可以将文件从多个代码库下载到本地工作目录</mark>。使用 Repo 执行基本的跨网络操作可大大简化文件管理工作。</p>
<h1 id="git">GIT</h1>
<p>对git的使用会分为 <a href="##INTROCUCTION"><strong>基础概念部分</strong></a>（即相关概念介绍）、<a href="##GIT%20COMMAND%20GRAMMER"><strong>指令语法</strong></a>、<a href="GIT%20SITUATION"><strong>使用场景</strong></a> 三部分。</p>
<h2 id="introduction">INTRODUCTION</h2>
<p><strong>DAG</strong>： Directed Acyclic Graph，有向无环图。</p>
<p><strong>DVCS</strong>： Distributed Version Control System，分布式版本控制系统。</p>
<h3 id="dvcs">DVCS</h3>
<p><strong>节点</strong>：在DVCS中，每个节点代表项目的一个修订（一个版本），这些对象通常被称为提交。</p>
<p><strong>有向边</strong>： 在DVCS中，每条边是基于两个修订之间的关系生成的。<mark style="font-weight: 900;">箭头是从父修订指向子修订的，代表他们之间的从属关系。</mark> 修订DAG中的箭头并不一定会形成闭环。通常修订的DAG是从左向右的结构（根节点在左，叶节点在右）或者自上而下结构（最新的版本在上面）。</p>
<h3 id="branch-tag-refs-hash-code">BRANCH / TAG / REFS / HASH-CODE</h3>
<p><strong>分支</strong>（branch）和 <strong>标签</strong> （tag）有时候也统称为 <strong>引用</strong>（refs），它们在修订 DAG 中的含义是样的，都是修订结构图表中的外部引用（指针）。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226205719300.png" alt="image-20220226205719300" /><figcaption aria-hidden="true">image-20220226205719300</figcaption>
</figure>
<blockquote>
<p>上图中，包含两个分支，当前的分支 Master 和另一分支 maint 。其中 <code>34ac2</code> 分支有一个 <code>v0.9</code> 的标签，另一个 <code>3fb00</code> 标签是合并提交的。</p>
</blockquote>
<p><strong>标签</strong>（tag），即 <strong>给定版本的符号名称</strong>，如 <code>v1.3-rc3</code> ，<mark style="font-weight: 900;">其永远指向相同对象，且不会变更</mark>。</p>
<blockquote>
<p>这就是一个允许开发人员快速查询和浏览的信息，且该信息必须对所有人来说都是具有相同意义的。</p>
</blockquote>
<p><strong>分支</strong>（branch），即 <strong>一系列开发工作的符号名称</strong>。</p>
<p>本地分支的引用信息都存放在 <code>.git/refs/heads/</code> 路径下，如 <code>master</code> 分支信息存放于 <code>.git/refs/heads/master</code> 中，而 <code>refs/heads/</code> 为该 <code>master</code> 的命名空间。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226211442066.png" alt="image-20220226211442066" /><figcaption aria-hidden="true">image-20220226211442066</figcaption>
</figure>
<blockquote>
<p>目前Git在硬盘中采用了两种截然不同的方式来表示分支：<strong>松散格式</strong> 和 <strong>压缩格式</strong>。</p>
<p>例如master分支（该分支是Git采用的默认分支名，用户在创建新的版本库时默认的分支名就是它）。</p>
<ul>
<li>采用 <strong>松散格式</strong> 时，它是 <code>.git/refs/heads/master</code> 中的一行文本，其中指代分支的 <strong>内容是十六进制的SHA-1码</strong>。</li>
<li>采用 <strong>压缩格式</strong> 时，它是 <code>.git/packed-refs</code> 中的一行文本，使用 <strong>最顶部修订的SHA-1码</strong> 和 <strong>分支全名一起</strong> 表示该分支。</li>
</ul>
</blockquote>
<h3 id="configuration">Configuration</h3>
<p>可以通过 <code>git config --global user.email ""</code> 和 <code>git config --global user.name ""</code> 进行配置，相关信息存储在 <code>~/.gitconfig</code> 文件中。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226203128964.png" alt="image-20220226203128964" /><figcaption aria-hidden="true">image-20220226203128964</figcaption>
</figure>
<h3 id="branch-name">Branch Name</h3>
<table>
<thead>
<tr class="header">
<th>分支</th>
<th>命名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>主分支</td>
<td>master</td>
<td>主分支，所有提供给用户使用的正式版本</td>
</tr>
<tr class="even">
<td>开发分支</td>
<td>dev</td>
<td>开发分支，永远是功能最新最全的版本</td>
</tr>
<tr class="odd">
<td>功能分支</td>
<td>feature-*</td>
<td>新功能分支，某个功能点正在开发的分支</td>
</tr>
<tr class="even">
<td>发布分支</td>
<td>release-*</td>
<td>发布定期要上线的功能</td>
</tr>
<tr class="odd">
<td>修复分支</td>
<td>bug-*</td>
<td>修复代码bug的分支</td>
</tr>
</tbody>
</table>
<h3 id="master">Master</h3>
<p>代码库应该有且仅有一个主分支。所有提供给用户使用的正式版本，都在这个主分支上发布。Git主分支的名字，默认称为 <code>Master</code> 。<code>Master</code> 主分支是自动建立的，版本库初始化以后，默认就是在主分支在进行开发。</p>
<p>主分支只用来分布重大版本，日常开发应该在另一条分支上完成。我们把开发用的分支，叫做 Dev 这个分支可以用来生成代码的最新隔夜版本（nightly）。如果想正式对外发布，就在 Master 分支上，对 Dev 分支进行”合并”（merge）。</p>
<h3 id="head">HEAD</h3>
<p><strong>git 中的分支</strong> 本质上是个指向 commit 对象的可变指针。</p>
<p>而在每一个使用 git 的 <code>.git/</code> 路径下，还保存着一个名为 <code>HEAD</code> 的特别指针，一般来说，它是指向正在工作中的本地分支的指针。</p>
<p><code>HEAD</code> 的指向是可以改变的，比如在 commit / checkout / branch / tag / retest / restore 等操作之后。</p>
<p>有的时候 <code>HEAD</code> 会指向一个没有分支名字的修订版本，这种情况叫 <strong><em>detached HEAD</em></strong>。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226203838866.png" alt="image-20220226203838866" /><figcaption aria-hidden="true">image-20220226203838866</figcaption>
</figure>
<p>在最底层实现中，Git 历史版本识别是通过一个 SHA-1 哈希码实现的，例如 <code>2b953b4380</code> 。</p>
<p>Git 支持多种形式的版本查询，其中就包括使用哈希码的精确匹配（最少提供4个字符）。</p>
<h2 id="git-command-grammer">GIT COMMAND GRAMMER</h2>
<ol type="1">
<li>使用 <code>git &lt;command&gt; -h</code> 可以获得该命令的所有参数用法帮助（简略的）。然后可以针对性地去搜索该指令和参数的用法。</li>
<li>下方会列出一些较为常见的（自己会使用得到的）命令及其参数。个别较常见的命令会贴上一张官方的参数用法图片。</li>
</ol>
<h3 id="git-add">git add</h3>
<h4 id="file-name">&lt;file name&gt;</h4>
<p>使用本命令参数可以直接确认某个文件的变动记录。</p>
<blockquote>
<p>如 <code>git add readme.md</code> 确认了 <code>readme.md</code> 文件的修改，<code>git add .</code> 确认了当前路径下包含的所有子路径和子文件的修改。</p>
</blockquote>
<h3 id="git-blame">git blame</h3>
<h4 id="file-name-1">&lt;file name&gt;</h4>
<p>本参数可以查看文件内部每一行内容的变动，例如新增一行，文件的编辑者等。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226202721363.png" alt="image-20220226202721363" /><figcaption aria-hidden="true">image-20220226202721363</figcaption>
</figure>
<blockquote>
<p>跟 <code>git diff</code> 不同的是，本命令是真的打开文件然后一行一行地给你修改和提示信息，包括每一行是谁写的</p>
</blockquote>
<h3 id="git-branch">git branch</h3>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226213748945.png" alt="image-20220226213748945" /><figcaption aria-hidden="true">image-20220226213748945</figcaption>
</figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch -D origin/xxxxxx</span><br><span class="line">git branch -D xxxxxx</span><br></pre></td></tr></table></figure>
<h4 id="a">-a</h4>
<p>使用本命令标志可以显示 <strong>本地 (local) 所有分支</strong> 和 <strong>远程 (remote) 所有分支</strong>。 其中，带 <code>*</code> 的为当前所在分支。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226200020105.png" alt="image-20220226200020105" /><figcaption aria-hidden="true">image-20220226200020105</figcaption>
</figure>
<h4 id="d-branch-name">-d &lt;branch name&gt;</h4>
<p>使用本命令标志可以删除 某个分支。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226211322680.png" alt="image-20220226211322680" /><figcaption aria-hidden="true">image-20220226211322680</figcaption>
</figure>
<h4 id="v">-v</h4>
<p>使用命令标志可以展示分支的哈希函数和commit信息，<code>-v</code> 即 <code>--verbose</code> ，表示 "冗长的"。</p>
<blockquote>
<p>例如: 下方，从 <code>master</code> 主分支刚创建出新分支 <code>SWV</code> 时，两者的哈希函数和commit信息是一样的。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226214736094.png" alt="image-20220226214736094" /><figcaption aria-hidden="true">image-20220226214736094</figcaption>
</figure>
<p>但修改了 <code>SWV</code> 分支的内容并确认提交之后，其哈希函数和commit信息就发生了改变。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226214912676.png" alt="image-20220226214912676" /><figcaption aria-hidden="true">image-20220226214912676</figcaption>
</figure>
</blockquote>
<h3 id="git-checkout">git checkout</h3>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226213843563.png" alt="image-20220226213843563" /><figcaption aria-hidden="true">image-20220226213843563</figcaption>
</figure>
<h4 id="branch">&lt;branch&gt;</h4>
<p>单独使用此参数可以用于切换分支（也有新的实验性语句 <code>switch</code> 可以使用，但是 <code>checkout</code> 更稳定）或恢复工作树文件。使用方式如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout dev</span><br><span class="line">git checkout origin/dev</span><br><span class="line">git checkout xxxxxx</span><br></pre></td></tr></table></figure>
<h4 id="b">-b</h4>
<p>使用本标志 + <code>&lt;new branch name&gt;</code> 可以创建一个新分支并切换至该分支，等同于 先使用 <code>git branch &lt;new branch name&gt;</code> 和 <code>git checkout &lt;new branch name&gt;</code> 。</p>
<h4 id="orphan-branch-name">--orphan &lt;branch name&gt;</h4>
<p>使用本命令标志可以创建一个与主分支没有联系的孤儿分支。</p>
<h3 id="git-commit">git commit</h3>
<h4 id="a-all">-a/-all</h4>
<p>使用本标志指 <strong>接受被追踪文件的所有变更</strong>，可以在暂存区创建一个注释来实现操作隔离。</p>
<h4 id="m">-m ""</h4>
<p>本标志和参数可以支持在 <code>""</code> 内实现对合并的快速注释。</p>
<h3 id="git-clone">git clone</h3>
<p>使用本命令可以直接从某个库中拷贝某个路径下的 repository，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@git.islet.space:srv/led_blink.git</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然，拷贝不公开的repository时，需要确保已经将自己的 SSH-key 加入到该网站的 <code>/home/git/.ssh/authorized_keys</code> 文件中。公开的 repository 可以随便拷贝。</p>
</blockquote>
<h3 id="git-diff">git diff</h3>
<p>本命令可以简要地查看距离上次 <code>commit</code> 操作到底修改什么信息。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226202625977.png" alt="image-20220226202625977" /><figcaption aria-hidden="true">image-20220226202625977</figcaption>
</figure>
<h3 id="git-log">git log</h3>
<p><strong>注意</strong>：所有的 <code>git log</code> 命令只会显示如下格式的 log 记录。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226202114879.png" alt="image-20220226202114879" /><figcaption aria-hidden="true">image-20220226202114879</figcaption>
</figure>
<h4 id="num">-&lt;num&gt;</h4>
<p>如输入 <code>git log -2</code>，可以查看当前项目最近两条的提交记录。</p>
<h4 id="author-或---committer">--author 或 --committer</h4>
<p>本标志支持查看提交者信息，使用方法如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --author=Linus</span><br></pre></td></tr></table></figure>
<h4 id="merges-或---no-merges">--merges 或 --no-merges</h4>
<p>本标志支持查看已合并和提交或非合并提交的信息。</p>
<h4 id="path-file-name">&lt;path / file name&gt;</h4>
<p>本参数可以</p>
<h3 id="git-merge">git merge</h3>
<p>默认情况下，Git执行 <strong>快进式合并</strong>（fast-forward merge），会直接将 Master 分支指向 Dev 分支。 使用 <code>–no–ff</code> 参数后，会执行正常合并，在 Master 分支上生成一个新节点。为了保证版本演进的清晰，我们希望采用这种做法。即：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge -no-ff dev</span><br></pre></td></tr></table></figure>
<h3 id="git-pull">git pull</h3>
<p>执行本命令后，Git系统会将服务器版本库中的变更下载到本机。自动将 remote 版本和 local 版本进行合并，然后把合并后的变更提交到<strong>本机</strong> 版本库中。</p>
<h3 id="git-push">git push</h3>
<h4 id="set-upstream">--set-upstream</h4>
<p>设置本地（新）分支的远程上游分支，一些在网上可以查找到的信息如下：</p>
<ul>
<li>set upstream branches to work properly</li>
<li>closely associated with remote branches</li>
<li>define the branch tracked on the remote branches (also called as remote tracking branch)</li>
<li><code>--set-upstream</code> is the same as <code>-u</code></li>
</ul>
<p>在本地创建的新分支如果希望在远程版本库中添加对应的上游分支，使用此命令和标志可以使得此分支推送至远程分支的目标更加明确。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push --set-upstream origin better-random</span><br></pre></td></tr></table></figure>
<h3 id="git-rebase">git rebase</h3>
<p>rebase是将自己的分支重新基于别人的分支之上，即，在别人的基础上再添加什么东西。</p>
<h3 id="git-reset">git reset</h3>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226223239807.png" alt="image-20220226223239807" /><figcaption aria-hidden="true">image-20220226223239807</figcaption>
</figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD^</span><br></pre></td></tr></table></figure>
<h3 id="git-remote">git remote</h3>
<p>本命令可以进行如下操作：</p>
<ol type="1">
<li>对远程repository进行 <strong>添加</strong>（add）、<strong>删除</strong>（remove）、<strong>重命名</strong>（rename）等操作。</li>
</ol>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226223823738.png" alt="image-20220226223823738" /><figcaption aria-hidden="true">image-20220226223823738</figcaption>
</figure>
<h3 id="git-status">git status</h3>
<p>直接使用本命令可以查看当前路径下所有文件的修改记录。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226223119337.png" alt="image-20220226223119337" /><figcaption aria-hidden="true">image-20220226223119337</figcaption>
</figure>
<h2 id="git-situation">GIT SITUATION</h2>
<h3 id="远程git-clone一个master分支为空的仓库时">远程git clone一个master分支为空的仓库时</h3>
<p>要么整个仓库都为空，要么肯定还有分支，使用 <code>git branch -a</code> 查看远程仓库分支，一般如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* dev</span><br><span class="line">  remotes/origin/xxxxxxxxxx</span><br><span class="line">  remotes/origin/HEAD -&gt; origin/dev</span><br><span class="line">  remotes/origin/dev</span><br><span class="line">  remotes/origin/master</span><br></pre></td></tr></table></figure>
<p>而正好 <code>xxxxxxxxxx</code> 可能就是真正存放现有文件的分支，使用 <code>git checkout origin/xxxxxxxxxx</code> 进行分支切换。</p>
<h3 id="conflict">conflict</h3>
<p>当文件冲突时，Git系统无法自动合并它们，因为可能这些代码块不是独立的。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220225214016189.png" alt="image-20220225214016189" /><figcaption aria-hidden="true">image-20220225214016189</figcaption>
</figure>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220225211850394.png" alt="image-20220225211850394" /><figcaption aria-hidden="true">image-20220225211850394</figcaption>
</figure>
<p><code>git pull</code> 也 pull 不下来。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220225212102034.png" alt="image-20220225212102034" /><figcaption aria-hidden="true">image-20220225212102034</figcaption>
</figure>
<h1 id="repo">REPO</h1>
<p>repo 部分将分为 <a href="##INSTALL%20REPO"><strong>安装repo</strong></a> 、<a href="##REPO%20COMMAND%20GRAMMER"><strong>命令语法</strong></a> 和 <a href="##REPO%20SITUATION"><strong>使用场景</strong></a> 三部分。</p>
<h2 id="install-repo">INSTALL REPO</h2>
<p><code>repo</code> 的安装有 <a href="###SETUP%20AUTOMATICALLY"><strong>自动</strong></a> 和 <a href="###SETUP%20MANUALLY"><strong>手动</strong></a> 两种，类 UNIX 系统都可以通过对应的包管理工具进行安装，但如果没有手动修改源，使用效果可能也不尽如人意。</p>
<p>安装完毕之后还需要进行 <a href="####VERIFICATION"><strong>版本验证</strong></a>，可能还需要 <a href="PYTHON%20NOT%20FOUND"><strong>对python版本进行更改</strong></a> 。</p>
<h3 id="setup-automatically">SETUP AUTOMATICALLY</h3>
<p>根据 google android <a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/develop?hl=zh-cn#installing-repo">installing repo</a> 指示，可以从 apt 包管理库中下载和安装 repo，也可以使用 google源、清华源或其他源进行手动下载。</p>
<p>Debian 系 Linux 的安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install repo</span><br></pre></td></tr></table></figure>
<p>Mac 安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo port install repo</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo brew install repo</span><br></pre></td></tr></table></figure>
<h3 id="setup-manually">SETUP MANUALLY</h3>
<p>手动安装 <code>repo</code> 的大概思路如下：</p>
<ol type="1">
<li>在用户根目录 <code>~</code> 下新建 <code>bin</code> 文件夹，即把 <code>$HOME/bin</code> 或 <code>~/bin</code> 当做 <code>repo</code> 的执行文件路径。</li>
<li>将该路径加入系统变量 <code>PATH</code> 中，可以通过写入 <code>~/.profile</code> 或对应的 shell 配置文件（如zsh的 <code>~/.zshrc</code> ）中并更新该配置文件来实现。</li>
<li>然后在该路径下载 repo的执行程序，主要是将某个 url 中（如下方所示为清华源的repo）的信息写入 <code>~/bin/repo</code> 中。</li>
<li>为所有用户 <code>a</code> 附加 <code>~/bin/repo</code> 的可执行 <code>x</code> 权限。</li>
<li>把 <code>export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'</code> 加入到配置文件中，使其一直生效（也可以在 terminal 中临时输入此命令，使其在设备重启前生效）。如果未写入 shell 的配置文件，则重启后该变量就会消失。</li>
</ol>
<p>下方代码以安装了 <code>zsh</code> shell 的 linux 或 debian 系系统为例，可以拷贝粘贴保存至脚本以运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动安装repo</span></span><br><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:<span class="variable">$PATH</span></span><br><span class="line">curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将源添加到shell配置文件并使其生效</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export REPO_URL=&#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo&#x27;&quot;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证信息</span></span><br><span class="line">repo version</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$REPO</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：google android用的是 <code>https://storage.googleapis.com/git-repo-downloads/repo</code> 的链接，但不是很方便下载，所以就更换成了清华源的。</p>
</blockquote>
<h4 id="verification">VERIFICATION</h4>
<p>安装完毕之后，可以对手动安装的 <code>repo</code> 进行版本验证，输入 <code>repo version</code> 和 <code>echo $REPO_URL</code> 即可，结果如下：</p>
<p>此处提示的 <code>&lt;repo not installed&gt;</code> 是正常的，因为在 <code>~</code> 目录下的确没有安装 <code>repo</code> .</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226193048479.png" alt="image-20220226193048479" /><figcaption aria-hidden="true">image-20220226193048479</figcaption>
</figure>
<h3 id="python-not-found">PYTHON NOT FOUND</h3>
<p>如果出现以下提示，则说明你的系统中没有为 <code>python</code> 添加 <strong>软连接</strong>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/env: ‘python’: No such file or directory</span><br></pre></td></tr></table></figure>
<h4 id="解决方法">解决方法</h4>
<ol type="1">
<li>验证是否已经安装了 <code>python2</code> ：输入命令 <code>python2 --version</code>，如果提示对应的版本信息则跳到 第3步，否则进行 第2步。</li>
<li>下载 <code>python2</code>：debian 系用户输入命令 <code>sudo apt install python2</code> 进行安装。mac系用户输入 <code>sudo port install python2</code> 进行安装。</li>
<li>在 <code>/usr/bin/</code> 目录下为 <code>python2</code> 创建软链：<code>sudo ln -s /usr/bin/python2 /usr/bin/python</code></li>
<li>再次运行 <code>repo init</code> 即可正常。</li>
</ol>
<p>如，在 Kali Linux 绑定 <code>python2</code> 为 <code>python</code> 之后，可以输入 <code>whereis python</code> 或 <code>python --version</code> 进行验证：</p>
<figure>
<img src="https://pic.islet.space/2022/01/image-20220125143434000.png" alt="image-20220125143434000" /><figcaption aria-hidden="true">image-20220125143434000</figcaption>
</figure>
<h2 id="repo-command-grammer">REPO COMMAND GRAMMER</h2>
<ol type="1">
<li>参考 <a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/develop/repo?hl=zh-cn#upload">Repo 命令参考资料</a></li>
<li>使用 <code>repo &lt;command&gt; -h</code> 可以获取相应命令的帮助。</li>
<li>在初始化过 repo 的路径下使用 <code>repo help</code> 可以获得以下信息：</li>
</ol>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226220906805.png" alt="image-20220226220906805" /><figcaption aria-hidden="true">image-20220226220906805</figcaption>
</figure>
<h3 id="repo-init">repo init</h3>
<p>执行下方的命令会在当前目录中创建一个 <code>.repo/</code> 目录并初始化 Repo 的版本控制，其中包含存放 Repo 源代码，以及从 URL（对应下方 <code>-u</code> 参数） 中同步下来的 Git 代码库 的某个分支 （对应下方 <code>-b</code> 参数）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo init -u &lt;git@xxxx.com:xxxx/manifest&gt; -b &lt;oneOfTheBranch&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-u</code>：即URL，指定从中检索清单代码库的网址。</li>
<li><code>-m</code>：选择代码库中的清单文件。如果未选择清单名称，则默认为 <code>default.xml</code>。</li>
<li><code>-b</code>：指定修订版本，即特定的 manifest-branch，可以是 <code>dev</code> 分支，也可以是特定分支，拉下来之后参照 <a href="##REPO%20SWITCH%20BRANCH">REPO SWITCH BRANCH</a> 进行分支切换。</li>
</ul>
<p><strong>注意</strong>：对于所有剩余的 Repo 命令，当前的工作目录必须是 <code>.repo/</code> 的父目录或该父目录的子目录。</p>
<h3 id="repo-branch">repo branch</h3>
<p>使用本命令可以查看所有的 <strong>目前可用的主题分支</strong>（currently available topic branches）。</p>
<h3 id="repo-sync">repo sync</h3>
<p>从 <code>manifest</code> 源中往外拉取分支。下方的 <code>-j&lt;number&gt;</code> 是指创建多线程进行数据资源获取，如 <code>-j4</code> 是指创建四线程进行数据资源获取。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repo sync</span><br><span class="line">repo sync -j4</span><br><span class="line">repo sync -j8</span><br></pre></td></tr></table></figure>
<blockquote>
<p>但，bitbucket的网络资源极差，很多情况下都拉不下来代码。</p>
</blockquote>
<h3 id="repo-help">repo help</h3>
<p>在其他地方如果没有运行过 <code>repo init</code> 而直接输入 <code>repo help</code> ，则会出现以下信息，详见 <a href="##REPO%20INIT">REPO INIT</a> 。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220226220753429.png" alt="image-20220226220753429" /><figcaption aria-hidden="true">image-20220226220753429</figcaption>
</figure>
<h2 id="repo-situation">REPO SITUATION</h2>
<h3 id="repo-switch-branch">REPO SWITCH BRANCH</h3>
<p>前文有说过 “借助单个 Repo 命令，<mark style="font-weight: 900;">可以将文件从多个代码库下载到本地工作目录</mark>”，即使用repo拉下来的是多个 git repository，且这个repo是通过 <code>.xml</code> 文件进行管理的，也就是它自身包含了一些版本和分支切换相关的信息。</p>
<p>如果要对repo拉下来的东西进行分支切换，就要参考一下步骤：</p>
<ol type="1">
<li>到 <code>.repo/manifest</code> 路径中。</li>
<li>使用 <code>git branch -a</code> 查看分支信息。</li>
<li>使用 <code>git checkout &lt;branch name&gt;</code> 进行分支切换。</li>
<li>再次使用 <code>repo sync</code> 命令进行同步。</li>
</ol>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220225211308567.png" alt="image-20220225211308567" /><figcaption aria-hidden="true">image-20220225211308567</figcaption>
</figure>
<p>下图是通过 <code>repo</code> 拉下来的多个git repository 之一中的隐藏文件，可以看到这个 <code>.git</code> 文件被使用指向上级 <code>.repo/</code> 路径下的某个 <code>.git</code> 文件，也就是说，需要先通过 <code>repo</code> 去拉取信息，再使用 <code>git</code> 来切换分支。</p>
<figure>
<img src="https://pic.islet.space/2022/02/image-20220225214801501.png" alt="image-20220225214801501" /><figcaption aria-hidden="true">image-20220225214801501</figcaption>
</figure>
<h1 id="reference">REFERENCE</h1>
<ol type="1">
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/06e1f67c8939">Git与Repo简单入门</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yiibai.com/git/git_rebase.html">git rebase 命令</a></li>
<li><a target="_blank" rel="noopener" href="https://git-scm.com/docs">git reference</a></li>
<li>《Git高手之路》，Jakub Narebski，人民邮电出版社</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://islet.space/2022/01/23/Computer/2022-01-23-%E7%BB%99Mac-Big-Sur%E4%BF%AE%E6%94%B9%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liewzheng">
      <meta itemprop="description" content="笔记分享的旮旯孤岛而已">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder的孤岛">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/23/Computer/2022-01-23-%E7%BB%99Mac-Big-Sur%E4%BF%AE%E6%94%B9%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87/" class="post-title-link" itemprop="url">给Mac Big Sur修改外接显示器的分辨率</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-01-23 17:30:00 / Modified: 18:11:59" itemprop="dateCreated datePublished" datetime="2022-01-23T17:30:00+08:00">2022-01-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer/" itemprop="url" rel="index"><span itemprop="name">Computer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文参考 《<a target="_blank" rel="noopener" href="https://zhangzi.life/articles/1605255382000">Mac 外接显示器色彩问题</a>》和 《<a target="_blank" rel="noopener" href="https://sspai.com/post/57549#!">为 macOS 10.15 开启 HiDPI，让 2K 显示器更舒适</a>》两篇文章。</p>
<p>刚买来新的 HUAWEI Mateview 无线版，显示器分辨率为 <code>3840*2560</code> ，该死的 <code>3:2</code> 屏幕啊，我图啥......</p>
<p>外接2015年的Macbook Air的MiniDP口输出准4K分辨率。</p>
<p>但是，但是，但是~~Air只能输出 <code>16:9</code> 和 <code>16:10</code> 的分辨率，让我搞了整整一下午来调整这个分辨率，4个小时啊。</p>
<p>算了，总结一下吧。</p>
<h1 id="关闭sip">关闭SIP</h1>
<p>Big sur 和之前版本不同，需要的操作如下：</p>
<ol type="1">
<li>关机</li>
<li>长按 <code>Command</code> 键 和 <code>R</code> 键（都不要松开），短按 开机电源键，直到出现进度条才能松开。</li>
<li>找到终端，然后输入 <code>csrutil authenticated-root disable</code> ，出现 <code>successfully</code> 字样就算是成功了。（之前的版本是 <code>csrutil disable</code> ）</li>
</ol>
<h1 id="查询设备号">查询设备号</h1>
<ol type="1">
<li>先断开显示器，输入如下代码：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ioreg -l | grep <span class="string">&quot;DisplayVendorID&quot;</span></span><br><span class="line">ioreg -l | grep <span class="string">&quot;DisplayProductID&quot;</span></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>再插上显示器，再次运行上方代码。</li>
<li>两次得出来的不同的设备号就可以区分哪个 <code>VendorID</code> 和 <code>ProductID</code> 是外接显示器的。</li>
</ol>
<figure>
<img src="https://pic.islet.space/2022/01/image-20220123175000229.png" alt="image-20220123175000229" /><figcaption aria-hidden="true">image-20220123175000229</figcaption>
</figure>
<ol start="4" type="1">
<li>记下那串代码，并将外接显示器的两个ID转换成对应的十六进制数， 如 <code>8950</code> 即 <code>22f6</code> , <code>28194</code> 即 <code>66e2</code></li>
</ol>
<h1 id="生成配置参数">生成配置参数</h1>
<ol type="1">
<li>在用户目录 ，即 <code>~</code> 下，使用 <code>DisplayVendorID-xxxx</code> （<code>xxxx</code> 即对应外接显示器 Vendor 号的16进制 ）创建一个文件夹。</li>
<li>然后在对应文件夹下创建一个 使用 <code>DisplayProductID-yyyy</code> （ yyyy` 即对应外接显示器 Product 号的16进制 ）创建一个无后缀名的文件。</li>
<li>到 <a target="_blank" rel="noopener" href="https://codeclou.github.io/Display-Override-PropertyList-File-Parser-and-Generator-with-HiDPI-Support-For-Scaled-Resolutions/">Scaled Resolution for your Mac</a> 网站生成配置参数，在红色框中分别填入你外接显示器的对应参数，和你想使你的显示器所呈现的分辨率参数。</li>
</ol>
<figure>
<img src="https://pic.islet.space/2022/01/image-20220123175609151.png" alt="image-20220123175609151" /><figcaption aria-hidden="true">image-20220123175609151</figcaption>
</figure>
<ol start="4" type="1">
<li>复制右侧的 xml 代码至刚刚的 <code>DisplayProductID-yyyy</code> 文件中，并保存。</li>
</ol>
<h1 id="导入系统">导入系统</h1>
<p>在Big Sur系统下，根目录 <code>/</code> 是禁止写入的，需要稍微用点技巧（走点弯路）。</p>
<ol type="1">
<li>新建一个文件夹，将解除SIP之后的 <code>/</code> 挂载到某个地方，如下方所示：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/nvme</span><br><span class="line">sudo mount -o nobrowse -t apfs /dev/disk1s5 ~/nvme/</span><br></pre></td></tr></table></figure>
<p>其中，<code>/dev/disk1s5</code> 中的 <code>/disk1s5</code> 要通过 <strong>磁盘工具</strong> 各自查看自己的 <strong>设备</strong> ，最后面的 <code>s1</code> 去掉不写。</p>
<figure>
<img src="https://pic.islet.space/2022/01/image-20220123173550666.png" alt="image-20220123173550666" /><figcaption aria-hidden="true">image-20220123173550666</figcaption>
</figure>
<ol start="2" type="1">
<li>然后就可以 <code>cd</code> 进去查看对应目录下的文件内容，但是所有读写操作都需要加上 <code>sudo</code> 才可以。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/nvme/System/Library/Displays/Contents/Resources/Overrides</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://pic.islet.space/2022/01/image-20220123173806535.png" alt="image-20220123173806535" /><figcaption aria-hidden="true">image-20220123173806535</figcaption>
</figure>
<ol start="3" type="1">
<li>把 <code>~/DisplayVendorID-xxxx</code> 复制到 <code>~/nvme/System/Library/Displays/Contents/Resources/Overrides</code> 里面：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -r ~/DisplayVendorID-22f6 ~/nvme/System/Library/Displays/Contents/Resources/Overrides/DisplayVendorID-22f6</span><br></pre></td></tr></table></figure>
<p>复制完毕之后可以再 <code>ls</code> 查看，就存在了。</p>
<ol start="4" type="1">
<li>但是这种复制只是一种暂时的，重启之后就会被镜像文件所覆盖，所以要重新 snapshot 一下。<mark style="font-weight: 900;">注意，这一步一定要做，否则重启就失效了。</mark></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bless --folder ~/nvme/System/Library/Displays/Contents/Resources/Overrides --bootefi --create-snapshot</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备19004822号 </a>
  </div>

<div class="copyright">
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liewzheng</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.12.0/dist/mermaid.min.js","integrity":"sha256-0dD7vUjUCTGJjeLnPotQQJIcSzug5fO6WDMYYyNIX4c="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/pace.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":"enable","tags":"all","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
